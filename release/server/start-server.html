<!DOCTYPE html>
<html>
<head>
    <title>Foundry REST API Server Launcher</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #2d2d2d;
            color: #fff;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #ff6400;
            margin-top: 0;
        }
        .status {
            padding: 15px;
            background: #333;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            background: #2d4a2d;
            border: 1px solid #4a7c4a;
        }
        .error {
            background: #4a2d2d;
            border: 1px solid #7c4a4a;
        }
        .instructions {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        button {
            background: #ff6400;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #e55a00;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Foundry REST API Server</h1>
        
        <div id="status" class="status">
            <p>This page helps you start the local WebSocket server for the Foundry REST API module.</p>
        </div>

        <div id="auto-launch" class="hidden">
            <h2>Attempting to launch server...</h2>
            <p>If the server doesn't start automatically, follow the manual instructions below.</p>
        </div>

        <div id="manual-instructions">
            <h2>Manual Start Instructions</h2>
            <p>To start the server, run these commands in your terminal:</p>
            <div class="instructions" id="commands">Loading...</div>
            
            <h3>Options:</h3>
            <button onclick="copyCommands()">Copy Commands</button>
            <button onclick="openTerminal()">Open Terminal</button>
        </div>

        <div id="verification">
            <h2>Verify Server Status</h2>
            <button onclick="checkServer()">Check Server Status</button>
            <div id="server-status"></div>
        </div>
    </div>

    <script>
        // Get the current directory path
        const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
        const serverPath = decodeURIComponent(currentPath);
        
        // Display the commands
        document.getElementById('commands').textContent = `cd "${serverPath}"
npm install  # (first time only)
npm start`;

        // Try to auto-launch using various methods
        function attemptAutoLaunch() {
            // Method 1: Try protocol handler (might work on some systems)
            try {
                window.location.href = `vscode://file${serverPath}`;
                setTimeout(() => {
                    // Try opening in terminal
                    window.location.href = `terminal://run?command=cd "${serverPath}" && npm start`;
                }, 1000);
            } catch (e) {
                console.log('Protocol handler failed:', e);
            }
        }

        // Copy commands to clipboard
        function copyCommands() {
            const commands = document.getElementById('commands').textContent;
            navigator.clipboard.writeText(commands).then(() => {
                alert('Commands copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = commands;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Commands copied to clipboard!');
            });
        }

        // Try to open terminal (platform-specific)
        function openTerminal() {
            const platform = navigator.platform.toLowerCase();
            if (platform.includes('win')) {
                // Windows
                window.open('ms-terminal://');
            } else if (platform.includes('mac')) {
                // macOS
                window.open('terminal://');
            } else {
                // Linux - try common terminal emulators
                window.open('gnome-terminal://');
            }
            
            // Show instructions
            alert('Terminal should be opening. Paste the copied commands to start the server.');
            copyCommands();
        }

        // Check if server is running
        async function checkServer() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.innerHTML = '<p>Checking server status...</p>';
            
            try {
                const ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = () => {
                    statusDiv.innerHTML = '<div class="status success">✓ Server is running on ws://localhost:8080</div>';
                    ws.close();
                };
                
                ws.onerror = () => {
                    statusDiv.innerHTML = '<div class="status error">✗ Server is not running. Please start it using the commands above.</div>';
                };
                
                // Timeout after 5 seconds
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                        statusDiv.innerHTML = '<div class="status error">✗ Server is not responding. Please start it using the commands above.</div>';
                    }
                }, 5000);
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">✗ Could not connect to server. Please start it using the commands above.</div>';
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            checkServer();
            // Try auto-launch if query parameter is present
            if (window.location.search.includes('autolaunch=true')) {
                document.getElementById('auto-launch').classList.remove('hidden');
                attemptAutoLaunch();
            }
        });

        // Close window/tab if opened as popup
        function closeWindow() {
            window.close();
            // If window.close() doesn't work, show a message
            setTimeout(() => {
                document.getElementById('status').innerHTML = 
                    '<p>You can close this window/tab now. Return to Foundry VTT to continue.</p>';
            }, 100);
        }
    </script>
</body>
</html>